# Monthly UTM Campaign Performance Analysis

This project provides SQL queries to analyze and summarize Facebook and Google ads data on a monthly basis, focusing on UTM campaign performance. The queries calculate various metrics and evaluate month-over-month changes, allowing for insights into key advertising trends over time.

## Query Overview

### CTE Definitions for Data Combination and Transformation
This query defines several Common Table Expressions (CTEs) to combine and analyze data across platforms:

1. **facebook_ads**: Retrieves Facebook ad data with metrics like `spend`, `impressions`, `reach`, `clicks`, `leads`, and `value`.
2. **all_ads_data**: Combines Facebook and Google ads data, creating a unified dataset for cross-platform analysis.
3. **MonthlyData**: Aggregates data by month and UTM campaign, calculating key metrics such as `CTR`, `CPC`, `CPM`, and `ROMI`.
4. **MonthlyChanges**: Calculates month-over-month percentage changes for key metrics, enabling performance trend analysis.

### Key Metrics and Calculations

- **Total Cost**: Sum of ad spend per month and UTM campaign.
- **Total Impressions**: Number of impressions for each campaign.
- **Total Clicks**: Total clicks per campaign.
- **Conversion Value**: Sum of `value` generated by conversions.
- **CTR (Click-through Rate)**: `(clicks * 100) / impressions`, showing engagement.
- **CPC (Cost per Click)**: `spend / clicks`, the average cost per click.
- **CPM (Cost per Thousand Impressions)**: `(spend * 1000) / impressions`.
- **ROMI (Return on Marketing Investment)**: `(value / spend) * 100`, representing profitability.

Month-over-month changes are calculated for each metric to show performance shifts over time.

### SQL Code

```sql
-- Facebook ve Google reklam verilerinin birleştirildiği CTE tanımlamaları
WITH facebook_ads AS (
    SELECT
        fabd.ad_date,
        fabd.url_parameters,
        fabd.spend,
        fabd.impressions,
        fabd.reach,
        fabd.clicks,
        fabd.leads,
        fabd.value
    FROM
        facebook_ads_basic_daily AS fabd
    LEFT JOIN
        facebook_adset AS fa
    ON
        fa.adset_id = fabd.adset_id
    LEFT JOIN
        facebook_campaign AS fc
    ON
        fc.campaign_id = fabd.campaign_id
),
all_ads_data AS (
    SELECT
        ad_date,
        url_parameters,
        spend,
        impressions,
        reach,
        clicks,
        leads,
        value
    FROM
        google_ads_basic_daily
    UNION ALL
    SELECT
        ad_date,
        url_parameters,
        spend,
        impressions,
        reach,
        clicks,
        leads,
        value
    FROM
        facebook_ads
),

-- Aylık bazda verilerin özetlendiği CTE
MonthlyData AS (
    SELECT
        TO_CHAR(DATE_TRUNC('month', ad_date), 'YYYY-MM-DD') AS ad_month,
        CASE
            WHEN LOWER(SUBSTRING(url_parameters FROM 'utm_campaign=([^&#$]+)')) = 'nan' THEN NULL
            ELSE LOWER(SUBSTRING(url_parameters FROM 'utm_campaign=([^&#$]+)'))
        END AS utm_campaign,
        COALESCE(SUM(spend), 0) AS total_cost,
        COALESCE(SUM(impressions), 0) AS number_of_impressions,
        COALESCE(SUM(clicks), 0) AS number_of_clicks,
        COALESCE(SUM(value), 0) AS conversion_value,
        ROUND(CASE WHEN SUM(impressions) > 0 THEN (SUM(clicks)::numeric * 100.0 / SUM(impressions)) ELSE 0 END, 2) AS ctr,
        ROUND(CASE WHEN SUM(clicks) > 0 THEN SUM(spend)::numeric / SUM(clicks) ELSE 0 END, 2) AS cpc,
        ROUND(CASE WHEN SUM(impressions) > 0 THEN (SUM(spend)::numeric * 1000.0 / SUM(impressions)) ELSE 0 END, 2) AS cpm,
        ROUND(CASE WHEN SUM(spend) > 0 THEN (SUM(value)::numeric / SUM(spend)) * 100 ELSE 0 END, 2) AS romi
    FROM
        all_ads_data
    GROUP BY
        ad_month,
        utm_campaign
),

-- Aylık değişimlerin hesaplandığı CTE
MonthlyChanges AS (
    SELECT
        ad_month,
        utm_campaign,
        total_cost,
        number_of_impressions,
        number_of_clicks,
        conversion_value,
        ctr,
        cpc,
        cpm,
        romi,
        LAG(ctr, 1) OVER (PARTITION BY utm_campaign ORDER BY ad_month) AS prev_ctr,
        LAG(cpc, 1) OVER (PARTITION BY utm_campaign ORDER BY ad_month) AS prev_cpc,
        LAG(cpm, 1) OVER (PARTITION BY utm_campaign ORDER BY ad_month) AS prev_cpm,
        LAG(romi, 1) OVER (PARTITION BY utm_campaign ORDER BY ad_month) AS prev_romi
    FROM
        MonthlyData
)

-- Nihai çıktı: Aylık veriler ve önceki aya göre yüzdelik değişimler
SELECT
    ad_month,
    utm_campaign,
    total_cost,
    number_of_impressions,
    number_of_clicks,
    conversion_value,
    ctr,
    prev_ctr,
    cpc,
    prev_cpc,
    cpm,
    prev_cpm,
    romi,
    prev_romi,
    ROUND(CASE WHEN prev_ctr = 0 OR prev_ctr IS NULL THEN NULL ELSE (ctr - prev_ctr) / prev_ctr * 100 END, 2) AS pct_change_ctr,
    ROUND(CASE WHEN prev_cpc = 0 OR prev_cpc IS NULL THEN NULL ELSE (cpc - prev_cpc) / prev_cpc * 100 END, 2) AS pct_change_cpc,
    ROUND(CASE WHEN prev_cpm = 0 OR prev_cpm IS NULL THEN NULL ELSE (cpm - prev_cpm) / prev_cpm * 100 END, 2) AS pct_change_cpm,
    ROUND(CASE WHEN prev_romi = 0 OR prev_romi IS NULL THEN NULL ELSE (romi - prev_romi) / prev_romi * 100 END, 2) AS pct_change_romi
FROM
    MonthlyChanges
ORDER BY
    ad_month,
    utm_campaign;
```

## Explanation of Key Metrics

- **Total Cost**: Sum of ad spend per month and UTM campaign.
- **Total Impressions**: Number of impressions for each campaign.
- **Total Clicks**: Total clicks per campaign.
- **Conversion Value**: Sum of value generated by conversions.
- **CTR (Click-through Rate)**: Percentage of impressions that resulted in clicks, calculated as `(clicks * 100) / impressions`.
- **CPC (Cost per Click)**: Cost per click, calculated as `spend / clicks`.
- **CPM (Cost per Thousand Impressions)**: Spend per 1,000 impressions, calculated as `(spend * 1000) / impressions`.
- **ROMI (Return on Marketing Investment)**: Profitability ratio calculated as `(value / spend) * 100`.

## Usage

- **Run the Combined Query**: To generate monthly performance insights for Facebook and Google campaigns, grouped by UTM parameters.
- **Analyze Monthly Changes**: Review month-over-month changes in CTR, CPC, CPM, and ROMI to track performance trends and identify shifts in campaign effectiveness.

## Example Output

| ad_month   | utm_campaign | total_cost | number_of_impressions | number_of_clicks | conversion_value | ctr | prev_ctr | cpc | prev_cpc | cpm | prev_cpm | romi | prev_romi | pct_change_ctr | pct_change_cpc | pct_change_cpm | pct_change_romi |
|------------|--------------|------------|-----------------------|------------------|------------------|-----|----------|-----|----------|-----|----------|------|-----------|----------------|----------------|----------------|-----------------|
| 2023-10-01 | fall_promo   | 1500       | 30000                | 300              | 5000             | 1.0 | 0.9      | 5.0 | 4.5      | 50  | 45       | 120  | 115       | 11.11          | 11.11          | 11.11          | 4.35            |

This output provides insights into monthly performance trends, highlighting changes in key metrics like CTR, CPC, CPM, and ROMI.

## Author & Contact Information

This analysis was developed by a data analyst with expertise in SQL and digital advertising analytics.

For further questions:
- **GitHub Issues**: Open an issue in the repository for questions or feedback.
- **Email**: Reach out via email at [dogankaraoglu025@gmail.com](mailto:dogankaraoglu025@gmail.com).

## Additional Resources

For more SQL-based data analysis projects, visit the [Dates-Times Window Function](https://github.com/Necodk/Data-Analysis-Projects/blob/main/SQL/Sql_Dates-Times_WindowFunction.sql).
